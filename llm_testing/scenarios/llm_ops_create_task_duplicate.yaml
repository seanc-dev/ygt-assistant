name: llm_ops_create_task_duplicate
mode: mock
steps:
  - action: reset_state
  - action: http
    method: POST
    url: /dev/workroom/seed
    expect:
      status: 200
  - action: http
    method: GET
    url: /api/workroom/tree
    expect:
      status: 200
    extract:
      task_id: "tree.0.children.0.id"
  - action: http
    method: POST
    url: /api/workroom/tasks/<task_id>/assistant-suggest
    json:
      message: "Create a new task called 'Review Q4 metrics' with high priority in the current project"
    expect:
      status: 200
      contains:
        - "operations"
    extract:
      create_op: "pending[?(@.op == 'create_task')]"
  - action: http
    method: POST
    url: /api/workroom/tasks/<task_id>/assistant-approve
    json:
      operation:
        __var__: create_op
    expect:
      status: 200
      jsonpath:
        "result.ok": true
  - action: http
    method: POST
    url: /api/workroom/tasks/<task_id>/assistant-approve
    json:
      operation:
        __var__: create_op
    expect:
      status: 409
      jsonpath:
        "detail.stock_message": "This project already has a task with that name. Would you like to name it something else?"

